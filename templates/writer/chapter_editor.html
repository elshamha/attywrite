{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.title }} - Writer's Web Dream{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css">
<style>
/* Ethereal Editor Container */
.ethereal-editor-container {
    height: calc(100vh - 80px);
    background: linear-gradient(135deg, 
        rgba(79, 172, 254, 0.05) 0%, 
        rgba(0, 242, 254, 0.05) 100%);
    overflow: hidden;
    position: relative;
}

/* Ethereal Editor Toolbar */
.ethereal-editor-toolbar {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.ethereal-document-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--ethereal-text) !important;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    padding: 12px 16px;
    border-radius: 12px;
    margin: 0;
    font-family: 'Inter', sans-serif;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.ethereal-document-title:hover, .ethereal-document-title:focus {
    background: rgba(255, 255, 255, 0.15);
    outline: none;
    box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
    transform: translateY(-2px);
}

.ethereal-editor-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.ethereal-share-btn, .ethereal-menu-btn {
    background: linear-gradient(135deg, 
        rgba(var(--ethereal-primary-rgb), 0.8) 0%, 
        rgba(var(--ethereal-secondary-rgb), 0.8) 100%);
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.ethereal-menu-btn {
    background: rgba(255, 255, 255, 0.1);
    color: var(--ethereal-text-primary);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 10px 12px;
}

.ethereal-share-btn:hover, .ethereal-menu-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.ethereal-menu-btn:hover {
    background: rgba(255, 255, 255, 0.15);
}

.ethereal-main-content {
    display: flex;
    height: calc(100% - 60px);
}

/* Ethereal Chapter Sidebar */
.ethereal-chapter-sidebar {
    width: 320px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(255, 255, 255, 0.15);
    overflow-y: auto;
    flex-shrink: 0;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
}

.ethereal-document-editor {
    flex: 1;
    background: transparent;
    overflow-y: auto;
    display: flex;
    justify-content: center;
    padding: 20px;
    position: relative;
}

/* Ethereal Paper Container */
.ethereal-paper-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    max-width: 816px;
    width: 100%;
    min-height: 1056px;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 0 40px rgba(var(--ethereal-primary-rgb), 0.1);
    margin: 0 auto;
    position: relative;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.ethereal-paper-content {
    padding: 96px 96px 96px 120px;
    min-height: calc(1056px - 192px);
    max-height: calc(1056px - 192px);
    line-height: 1.6;
    font-family: var(--font-family-primary);
    font-size: 12pt;
    color: var(--ethereal-text-primary);
    overflow: hidden;
    position: relative;
    border-radius: 20px;
}

/* Ethereal Chapter Outline Sidebar */
.ethereal-outline-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.1);
}

.ethereal-outline-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--ethereal-text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.ethereal-outline-content {
    padding: 12px 0;
}

.ethereal-chapter-item {
    position: relative;
    padding: 12px 20px 12px 40px;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    margin: 4px 8px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
}

.ethereal-chapter-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(8px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.ethereal-chapter-item.active {
    background: linear-gradient(135deg, 
        rgba(var(--ethereal-primary-rgb), 0.2) 0%, 
        rgba(var(--ethereal-secondary-rgb), 0.2) 100%);
    border-left-color: var(--ethereal-primary);
    box-shadow: 0 8px 30px rgba(var(--ethereal-primary-rgb), 0.3);
    transform: translateX(12px);
}

.ethereal-chapter-item.active .chapter-title {
    color: var(--ethereal-primary);
    font-weight: 600;
    text-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-drag-handle {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.4);
    cursor: grab;
    opacity: 0;
    transition: all 0.3s ease;
}

.ethereal-chapter-item:hover .ethereal-drag-handle {
    opacity: 1;
    color: var(--ethereal-primary);
}

.ethereal-chapter-item.sortable-chosen .ethereal-drag-handle {
    cursor: grabbing;
}

.ethereal-chapter-number {
    background: linear-gradient(135deg, 
        rgba(var(--ethereal-primary-rgb), 0.2) 0%, 
        rgba(var(--ethereal-secondary-rgb), 0.2) 100%);
    color: var(--ethereal-primary);
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    margin-right: 12px;
    flex-shrink: 0;
    border: 1px solid rgba(var(--ethereal-primary-rgb), 0.3);
    transition: all 0.3s ease;
}

.ethereal-chapter-item.active .ethereal-chapter-number {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.5);
}

.ethereal-chapter-title {
    font-size: 14px;
    color: var(--ethereal-text-primary);
    flex-grow: 1;
    margin-right: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
}

.ethereal-chapter-actions {
    opacity: 0;
    display: flex;
    gap: 6px;
    transition: all 0.3s ease;
}

.ethereal-chapter-item:hover .ethereal-chapter-actions {
    opacity: 1;
}

.ethereal-chapter-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 8px;
    padding: 6px;
    color: var(--ethereal-text-muted);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
}

.ethereal-chapter-action-btn:hover {
    background: rgba(220, 53, 69, 0.2);
    color: #ff6b7a;
    transform: scale(1.1);
}

.ethereal-add-chapter-section {
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.05);
}

.ethereal-add-chapter-form {
    display: flex;
    gap: 12px;
}

.ethereal-add-chapter-input {
    flex: 1;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 14px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--ethereal-text-primary);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.ethereal-add-chapter-input:focus {
    outline: none;
    border-color: var(--ethereal-primary);
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.3);
    background: rgba(255, 255, 255, 0.15);
}

.ethereal-add-chapter-btn {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    border: none;
    padding: 12px 18px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-add-chapter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(var(--ethereal-primary-rgb), 0.4);
}

/* Ethereal Editor Content */
.ethereal-current-chapter-title {
    font-size: 28px;
    font-weight: 600;
    color: var(--ethereal-text-primary);
    border: none;
    background: transparent;
    width: 100%;
    margin-bottom: 32px;
    padding: 12px 0;
    font-family: var(--font-family-primary);
    line-height: 1.3;
    transition: all 0.3s ease;
}

.ethereal-current-chapter-title:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px 16px;
    margin: -12px -16px 20px -16px;
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.2);
}

.ethereal-chapter-content-editor {
    width: 100%;
    height: calc(100% - 80px);
    max-height: calc(864px - 96px - 80px);
    border: none;
    outline: none;
    resize: none;
    font-family: var(--font-family-primary);
    font-size: 12pt;
    line-height: 1.6;
    color: var(--ethereal-text-primary);
    background: transparent;
    will-change: contents;
    transform: translateZ(0);
    display: none;
    overflow-y: auto;
}

.ethereal-chapter-content-editor:focus {
    outline: none;
}

.ethereal-chapter-content-editor.fallback-active {
    display: block !important;
    padding: 24px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    font-family: "Georgia", "Times New Roman", serif;
    font-size: 16px;
    line-height: 1.6;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
}

#editor-content {
    height: calc(100% - 60px);
    max-height: calc(864px - 96px - 60px);
    overflow: hidden;
    position: relative;
}

/* Ethereal Empty State */
.ethereal-empty-editor {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--ethereal-text-muted);
    text-align: center;
    padding: 60px 40px;
}

.ethereal-empty-editor i {
    font-size: 64px;
    margin-bottom: 24px;
    color: var(--ethereal-primary);
    opacity: 0.6;
    filter: drop-shadow(0 0 20px rgba(var(--ethereal-primary-rgb), 0.3));
}

.ethereal-empty-editor h3 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--ethereal-text-primary);
}

.ethereal-empty-editor p {
    font-size: 16px;
    margin: 0;
    opacity: 0.8;
}

/* Ethereal Status Indicators */
.ethereal-save-status {
    font-size: 12px;
    color: var(--ethereal-text-muted);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.ethereal-save-status.saving {
    color: var(--ethereal-primary);
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-save-status i {
    font-size: 10px;
}

/* Ethereal Auto-save Toast */
.ethereal-auto-save-toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30, 30, 30, 0.95);
    backdrop-filter: blur(20px);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 500;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.ethereal-auto-save-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-10px);
}

/* Ethereal Right Sidebar Styles */
.ethereal-right-sidebar {
    width: 360px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(255, 255, 255, 0.15);
    display: flex;
    flex-direction: column;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
}

.ethereal-right-sidebar.collapsed {
    width: 60px;
    overflow: hidden;
}

.ethereal-sidebar-header {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    position: relative;
}

.ethereal-sidebar-tabs {
    display: flex;
    flex: 1;
}

.ethereal-sidebar-tab {
    flex: 1;
    background: transparent;
    border: none;
    padding: 16px 12px;
    font-size: 12px;
    color: var(--ethereal-text-muted);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    border-bottom: 3px solid transparent;
    position: relative;
    overflow: hidden;
}

.ethereal-sidebar-tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(var(--ethereal-primary-rgb), 0.1) 0%, 
        rgba(var(--ethereal-secondary-rgb), 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.ethereal-sidebar-tab:hover {
    color: var(--ethereal-text-primary);
    transform: translateY(-2px);
}

.ethereal-sidebar-tab:hover::before {
    opacity: 1;
}

.ethereal-sidebar-tab.active {
    color: var(--ethereal-primary);
    border-bottom-color: var(--ethereal-primary);
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.2);
}

.ethereal-sidebar-tab i {
    font-size: 16px;
    filter: drop-shadow(0 0 10px rgba(var(--ethereal-primary-rgb), 0.3));
}

.ethereal-sidebar-tab span {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ethereal-sidebar-toggle {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    padding: 16px;
    color: var(--ethereal-text-muted);
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
}

.ethereal-sidebar-toggle:hover {
    background: rgba(255, 255, 255, 0.15);
    color: var(--ethereal-primary);
    transform: scale(1.1);
}

.ethereal-right-sidebar.collapsed .ethereal-sidebar-toggle i {
    transform: rotate(180deg);
}

.ethereal-sidebar-panel {
    flex: 1;
    overflow-y: auto;
    display: none;
    padding: 20px;
}

.ethereal-sidebar-panel.active {
    display: block;
}

.ethereal-panel-content {
    height: 100%;
}

.ethereal-panel-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--ethereal-text-primary);
    margin-bottom: 16px;
    text-align: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
}

.ethereal-panel-title::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 2px;
    background: linear-gradient(90deg, var(--ethereal-primary), var(--ethereal-secondary));
    border-radius: 2px;
}

/* Ethereal AI Assistant Styles */
.ethereal-ai-quick-actions {
    margin-bottom: 32px;
}

.ethereal-quick-action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.ethereal-quick-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 16px 12px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--ethereal-text-muted);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.ethereal-quick-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(var(--ethereal-primary-rgb), 0.2) 0%, 
        rgba(var(--ethereal-secondary-rgb), 0.2) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.ethereal-quick-action-btn:hover {
    border-color: var(--ethereal-primary);
    color: var(--ethereal-primary);
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-quick-action-btn:hover::before {
    opacity: 1;
}

.ethereal-quick-action-btn i {
    font-size: 18px;
    z-index: 1;
    position: relative;
}

.ethereal-quick-action-btn span {
    z-index: 1;
    position: relative;
    font-weight: 600;
}

.ethereal-ai-chat-section {
    display: flex;
    flex-direction: column;
    height: calc(100% - 180px);
}

.ethereal-ai-chat-container {
    flex: 1;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    padding: 16px;
    overflow-y: auto;
    margin-bottom: 16px;
    max-height: 320px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
}

.ethereal-welcome-message {
    text-align: center;
    color: var(--ethereal-text-muted);
    font-size: 12px;
    line-height: 1.5;
    padding: 20px;
}

.ethereal-welcome-message i {
    font-size: 28px;
    margin-bottom: 12px;
    display: block;
    filter: drop-shadow(0 0 15px rgba(var(--ethereal-primary-rgb), 0.4));
}

.ethereal-ai-message {
    margin-bottom: 16px;
    font-size: 12px;
    line-height: 1.5;
}

.ethereal-ai-message.user {
    text-align: right;
}

.ethereal-ai-message.user .message-content {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    padding: 12px 16px;
    border-radius: 18px 18px 6px 18px;
    display: inline-block;
    max-width: 80%;
    box-shadow: 0 4px 15px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-ai-message.assistant .message-content {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 12px 16px;
    border-radius: 18px 18px 18px 6px;
    display: inline-block;
    max-width: 90%;
    color: var(--ethereal-text-primary);
}

.ethereal-ai-input-section {
    margin-top: auto;
}

.ethereal-ai-input-section .input-group {
    display: flex;
    gap: 12px;
}

.ethereal-ai-input {
    flex: 1;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    padding: 12px 18px;
    font-size: 12px;
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: var(--ethereal-text-primary);
    transition: all 0.3s ease;
}

.ethereal-ai-input:focus {
    border-color: var(--ethereal-primary);
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.3);
    background: rgba(255, 255, 255, 0.15);
}

.ethereal-ai-send-btn {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-ai-send-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(var(--ethereal-primary-rgb), 0.4);
}

/* Ethereal Characters Panel Styles */
.ethereal-characters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.ethereal-detect-characters-btn {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-detect-characters-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(var(--ethereal-primary-rgb), 0.4);
}

.ethereal-characters-list {
    margin-bottom: 20px;
    max-height: 320px;
    overflow-y: auto;
}

.ethereal-no-characters-message {
    text-align: center;
    color: var(--ethereal-text-muted);
    font-size: 12px;
    padding: 30px 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ethereal-no-characters-message i {
    font-size: 32px;
    margin-bottom: 12px;
    display: block;
    filter: drop-shadow(0 0 15px rgba(var(--ethereal-primary-rgb), 0.3));
}

.ethereal-character-item {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    position: relative;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.ethereal-character-item:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(var(--ethereal-primary-rgb), 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.ethereal-character-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--ethereal-text-primary);
    margin-bottom: 6px;
}

.ethereal-character-count {
    font-size: 11px;
    color: var(--ethereal-text-muted);
    margin-bottom: 12px;
    opacity: 0.8;
}

.ethereal-character-notes {
    width: 100%;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    font-size: 11px;
    color: var(--ethereal-text-muted);
    resize: none;
    outline: none;
    min-height: 50px;
    border-radius: 8px;
    padding: 8px 12px;
    transition: all 0.3s ease;
}

.ethereal-character-notes:focus {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid var(--ethereal-primary);
    color: var(--ethereal-text-primary);
    box-shadow: 0 0 15px rgba(var(--ethereal-primary-rgb), 0.2);
}

.ethereal-character-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.ethereal-character-item:hover .ethereal-character-actions {
    opacity: 1;
}

.ethereal-character-action-btn {
    background: rgba(220, 53, 69, 0.2);
    border: none;
    color: #ff6b7a;
    cursor: pointer;
    padding: 6px;
    border-radius: 8px;
    font-size: 10px;
    transition: all 0.2s ease;
}

.ethereal-character-action-btn:hover {
    background: rgba(220, 53, 69, 0.3);
    transform: scale(1.1);
}

.ethereal-add-character-section .input-group {
    display: flex;
    gap: 12px;
}

.ethereal-character-input {
    flex: 1;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 12px;
    outline: none;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: var(--ethereal-text-primary);
    transition: all 0.3s ease;
}

.ethereal-character-input:focus {
    border-color: var(--ethereal-primary);
    box-shadow: 0 0 20px rgba(var(--ethereal-primary-rgb), 0.3);
    background: rgba(255, 255, 255, 0.15);
}

.ethereal-add-character-btn {
    background: linear-gradient(135deg, var(--ethereal-primary), var(--ethereal-secondary));
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--ethereal-primary-rgb), 0.3);
}

.ethereal-add-character-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(var(--ethereal-primary-rgb), 0.4);
}

/* Ethereal Responsive Design */
@media (max-width: 1200px) {
    .ethereal-right-sidebar {
        width: 320px;
    }
}

@media (max-width: 768px) {
    .ethereal-main-content {
        flex-direction: column;
    }
    
    .ethereal-chapter-sidebar {
        width: 100%;
        height: 220px;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .ethereal-right-sidebar {
        width: 100%;
        height: 320px;
        border-left: none;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        order: 3;
    }
    
    .ethereal-sidebar-header {
        flex-direction: row;
    }
    
    .ethereal-sidebar-tabs {
        flex-direction: row;
    }
    
    .ethereal-sidebar-tab {
        flex-direction: row;
        gap: 12px;
        padding: 16px 20px;
    }
    
    .ethereal-sidebar-panel {
        padding: 16px;
    }
    
    .ethereal-ai-chat-container {
        max-height: 180px;
    }
    
    .ethereal-document-editor {
        padding: 16px;
    }
    
    .ethereal-paper-container {
        max-width: 100%;
        margin: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border-radius: 16px;
    }
    
    .ethereal-paper-content {
        padding: 60px 32px;
    }
}

/* Ethereal CKEditor Overrides */
.ck-editor {
    border: none !important;
    background: transparent !important;
}

.ck-editor__main {
    background: transparent !important;
}

.ck-editor__editable {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    font-family: var(--font-family-primary) !important;
    font-size: 12pt !important;
    line-height: 1.6 !important;
    padding: 0 !important;
    height: calc(100% - 10px) !important;
    max-height: calc(864px - 96px - 80px) !important;
    min-height: 400px !important;
    overflow-y: auto !important;
    color: var(--ethereal-text-primary) !important;
}

.ck-editor__editable:focus {
    box-shadow: none !important;
    border: none !important;
    outline: none !important;
}

.ck-toolbar {
    border: none !important;
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(10px) !important;
    padding: 12px 0 20px 0 !important;
    border-radius: 12px !important;
    margin-bottom: 20px !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

.ck-toolbar__items {
    flex-wrap: wrap;
}

.ck-button {
    border-radius: 8px !important;
    margin: 0 4px !important;
    padding: 8px !important;
    transition: all 0.2s ease !important;
}

.ck-button:hover {
    background: rgba(255, 255, 255, 0.15) !important;
    transform: translateY(-1px) !important;
}

.ck-button.ck-on {
    background: rgba(var(--ethereal-primary-rgb), 0.2) !important;
    color: var(--ethereal-primary) !important;
    box-shadow: 0 0 15px rgba(var(--ethereal-primary-rgb), 0.3) !important;
}

/* Ethereal Paste Restriction and Auto-split Notifications */
.ethereal-paste-restriction-toast {
    position: fixed;
    top: 30px;
    right: 30px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    animation: etherealSlideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.ethereal-auto-split-notification {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: linear-gradient(135deg, 
        rgba(255, 193, 7, 0.95) 0%, 
        rgba(255, 152, 0, 0.95) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    z-index: 10000;
    animation: etherealSlideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    color: white;
}

@keyframes etherealSlideInRight {
    from { 
        transform: translateX(100%); 
        opacity: 0;
    }
    to { 
        transform: translateX(0); 
        opacity: 1;
    }
}

@keyframes etherealSlideInUp {
    from { 
        transform: translateY(100%); 
        opacity: 0;
    }
    to { 
        transform: translateY(0); 
        opacity: 1;
    }
}

/* Ethereal Loading States */
.ethereal-btn-loading {
    position: relative;
    pointer-events: none;
    opacity: 0.8;
}

.ethereal-btn-loading::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    top: 50%;
    left: 50%;
    margin-left: -9px;
    margin-top: -9px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: ethereal-spin 1s linear infinite;
}

@keyframes ethereal-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Ethereal Scrollbar Styling */
.ethereal-ai-chat-container::-webkit-scrollbar,
.ethereal-characters-list::-webkit-scrollbar,
.ethereal-outline-content::-webkit-scrollbar,
.ethereal-chapter-content-editor::-webkit-scrollbar {
    width: 6px;
}

.ethereal-ai-chat-container::-webkit-scrollbar-track,
.ethereal-characters-list::-webkit-scrollbar-track,
.ethereal-outline-content::-webkit-scrollbar-track,
.ethereal-chapter-content-editor::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.ethereal-ai-chat-container::-webkit-scrollbar-thumb,
.ethereal-characters-list::-webkit-scrollbar-thumb,
.ethereal-outline-content::-webkit-scrollbar-thumb,
.ethereal-chapter-content-editor::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--ethereal-primary), var(--ethereal-secondary));
    border-radius: 3px;
}

.ethereal-ai-chat-container::-webkit-scrollbar-thumb:hover,
.ethereal-characters-list::-webkit-scrollbar-thumb:hover,
.ethereal-outline-content::-webkit-scrollbar-thumb:hover,
.ethereal-chapter-content-editor::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, var(--ethereal-secondary), var(--ethereal-primary));
}

/* Pagination Controls */
.pagination-controls {
    border-top: 1px solid #e8eaed;
    border-bottom: 1px solid #e8eaed;
    padding: 8px 0;
}

.pagination-controls .btn {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
}

.pagination-controls .btn-group {
    box-shadow: 0 1px 3px rgba(60,64,67,.12);
}

.pagination-info {
    text-align: center;
    font-size: 11px;
    color: #5f6368;
    padding: 4px 0;
    border-bottom: 1px solid #f1f3f4;
}

/* Chapter Navigation Enhancement */
.chapter-item.active {
    background: linear-gradient(135deg, #e8f0fe, #f8f9fa);
    border-left-color: #1a73e8;
    box-shadow: 0 1px 3px rgba(26,115,232,.2);
}

/* Paste Restriction Toast */
.paste-restriction-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border: 1px solid #dadce0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideInRight 0.3s ease;
}

.toast-content {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 12px;
}

.toast-text {
    flex: 1;
    font-size: 14px;
}

.toast-close {
    background: none;
    border: none;
    color: #5f6368;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}

.toast-close:hover {
    background: #f1f3f4;
}

/* Auto Split Notification */
.auto-split-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideInUp 0.3s ease;
}

.notification-content {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 12px;
}

.notification-text {
    flex: 1;
    font-size: 14px;
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

@keyframes slideInUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* Responsive design */
@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }
    
    .chapter-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .document-editor {
        padding: 16px;
    }
    
    .paper-container {
        max-width: 100%;
        margin: 0;
        box-shadow: none;
    }
    
    .paper-content {
        padding: 40px 24px;
    }
}

/* CKEditor overrides for Google Docs style */
.ck-editor {
    border: none !important;
    background: transparent !important;
}

.ck-editor__main {
    background: transparent !important;
}

.ck-editor__editable {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    font-family: var(--font-family-primary) !important;
    font-size: 11pt !important;
    line-height: 1.15 !important;
    padding: 0 !important;
    height: calc(100% - 10px) !important;
    max-height: calc(864px - 96px - 60px) !important; /* Stay within content bounds */
    min-height: 400px !important; /* Minimum usable height */
    overflow-y: auto !important;
}

.ck-editor__editable:focus {
    box-shadow: none !important;
    border: none !important;
    outline: none !important;
}

.ck-toolbar {
    border: none !important;
    background: transparent !important;
    padding: 0 0 16px 0 !important;
}

.ck-toolbar__items {
    flex-wrap: wrap;
}

.ck-button {
    border-radius: 4px !important;
    margin: 0 2px !important;
}

.ck-button:hover {
    background: #f1f3f4 !important;
}

.ck-button.ck-on {
    background: #e8f0fe !important;
    color: #1a73e8 !important;
}

/* Right Sidebar Styles */
.right-sidebar {
    width: 320px;
    background: white;
    border-left: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease, margin-right 0.3s ease;
    flex-shrink: 0;
}

.right-sidebar.collapsed {
    width: 48px;
    overflow: hidden;
}

.sidebar-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    position: relative;
}

.sidebar-tabs {
    display: flex;
    flex: 1;
}

.sidebar-tab {
    flex: 1;
    background: transparent;
    border: none;
    padding: 12px 8px;
    font-size: 12px;
    color: #5f6368;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    border-bottom: 2px solid transparent;
}

.sidebar-tab:hover {
    background: #f1f3f4;
    color: #202124;
}

.sidebar-tab.active {
    color: #1a73e8;
    border-bottom-color: #1a73e8;
    background: white;
}

.sidebar-tab i {
    font-size: 14px;
}

.sidebar-tab span {
    font-size: 10px;
    font-weight: 500;
}

.sidebar-toggle {
    background: transparent;
    border: none;
    padding: 12px;
    color: #5f6368;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 1px solid #e0e0e0;
}

.sidebar-toggle:hover {
    background: #f1f3f4;
    color: #202124;
}

.right-sidebar.collapsed .sidebar-toggle i {
    transform: rotate(180deg);
}

.sidebar-panel {
    flex: 1;
    overflow-y: auto;
    display: none;
    padding: 16px;
}

.sidebar-panel.active {
    display: block;
}

.panel-content {
    height: 100%;
}

.panel-title {
    font-size: 13px;
    font-weight: 500;
    color: #202124;
    margin-bottom: 12px;
}

/* AI Assistant Styles */
.ai-quick-actions {
    margin-bottom: 24px;
}

.quick-action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.quick-action-btn {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #5f6368;
}

.quick-action-btn:hover {
    background: #e8f0fe;
    border-color: #1a73e8;
    color: #1a73e8;
}

.quick-action-btn i {
    font-size: 16px;
}

.ai-chat-section {
    display: flex;
    flex-direction: column;
    height: calc(100% - 160px);
}

.ai-chat-container {
    flex: 1;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px;
    overflow-y: auto;
    margin-bottom: 12px;
    max-height: 300px;
    background: #fafafa;
}

.welcome-message {
    text-align: center;
    color: #5f6368;
    font-size: 12px;
    line-height: 1.4;
}

.welcome-message i {
    font-size: 20px;
    margin-bottom: 8px;
    display: block;
}

.ai-message {
    margin-bottom: 12px;
    font-size: 12px;
    line-height: 1.4;
}

.ai-message.user {
    text-align: right;
}

.ai-message.user .message-content {
    background: #1a73e8;
    color: white;
    padding: 8px 12px;
    border-radius: 12px 12px 4px 12px;
    display: inline-block;
    max-width: 80%;
}

.ai-message.assistant .message-content {
    background: white;
    border: 1px solid #e0e0e0;
    padding: 8px 12px;
    border-radius: 12px 12px 12px 4px;
    display: inline-block;
    max-width: 90%;
}

.ai-input-section {
    margin-top: auto;
}

.input-group {
    display: flex;
    gap: 8px;
}

.ai-input {
    flex: 1;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 12px;
    outline: none;
}

.ai-input:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
}

.ai-send-btn {
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}

.ai-send-btn:hover {
    background: #1557b0;
}

/* Characters Panel Styles */
.characters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.detect-characters-btn {
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 11px;
    cursor: pointer;
    transition: background 0.2s;
}

.detect-characters-btn:hover {
    background: #1557b0;
}

.characters-list {
    margin-bottom: 16px;
    max-height: 300px;
    overflow-y: auto;
}

.no-characters-message {
    text-align: center;
    color: #5f6368;
    font-size: 12px;
    padding: 20px;
}

.no-characters-message i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

.character-item {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
    position: relative;
}

.character-name {
    font-weight: 500;
    font-size: 13px;
    color: #202124;
    margin-bottom: 4px;
}

.character-count {
    font-size: 11px;
    color: #5f6368;
    margin-bottom: 8px;
}

.character-notes {
    width: 100%;
    border: none;
    background: transparent;
    font-size: 11px;
    color: #5f6368;
    resize: none;
    outline: none;
    min-height: 40px;
}

.character-notes:focus {
    background: white;
    border: 1px solid #1a73e8;
    border-radius: 4px;
    padding: 4px;
}

.character-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.character-item:hover .character-actions {
    opacity: 1;
}

.character-action-btn {
    background: transparent;
    border: none;
    color: #5f6368;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    font-size: 10px;
}

.character-action-btn:hover {
    background: #e0e0e0;
    color: #202124;
}

.character-input {
    flex: 1;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 12px;
    outline: none;
}

.character-input:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
}

.add-character-btn {
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
}

.add-character-btn:hover {
    background: #1557b0;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .right-sidebar {
        width: 280px;
    }
}

@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }
    
    .right-sidebar {
        width: 100%;
        height: 300px;
        border-left: none;
        border-top: 1px solid #e0e0e0;
        order: 3;
    }
    
    .sidebar-header {
        flex-direction: row;
    }
    
    .sidebar-tabs {
        flex-direction: row;
    }
    
    .sidebar-tab {
        flex-direction: row;
        gap: 8px;
        padding: 12px 16px;
    }
    
    .sidebar-panel {
        padding: 12px;
    }
    
    .ai-chat-container {
        max-height: 150px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="ethereal-editor-container">
    <!-- Ethereal Editor Toolbar -->
    <div class="ethereal-editor-toolbar">
        <input type="text" 
               class="ethereal-document-title" 
               value="{{ project.title }}" 
               placeholder="Untitled magical document">
        
        <div class="ethereal-editor-actions">
            <span class="ethereal-save-status" id="save-status">
                <i class="fas fa-check"></i>
                All changes saved in the ethereal realm
            </span>
            <button class="ethereal-menu-btn" title="Ethereal Menu">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <button class="ethereal-share-btn">
                <i class="fas fa-share me-2"></i>
                Share Magic
            </button>
        </div>
    </div>

    <!-- Ethereal Main Content Area -->
    <div class="ethereal-main-content">
        <!-- Ethereal Chapter Outline Sidebar -->
        <div class="ethereal-chapter-sidebar">
            <div class="ethereal-outline-header">
                <h3 class="ethereal-outline-title">
                    <i class="fas fa-list-ul ethereal-icon-glow"></i>
                    Magical Document Outline
                </h3>
            </div>
            
            <div class="ethereal-outline-content">
                <!-- Ethereal Pagination Info -->
                {% if chapters.has_other_pages %}
                <div class="pagination-info mb-3 p-3 mx-2 rounded" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <small class="ethereal-text-muted d-block mb-2">
                        <i class="fas fa-scroll me-1"></i>
                        Chapters {{ chapters.start_index }}-{{ chapters.end_index }} of {{ chapters.paginator.count }}
                        (Page {{ chapters.number }} of {{ chapters.paginator.num_pages }})
                    </small>
                    {% if current_chapter and current_chapter_page != chapters.number %}
                    <div class="mb-2">
                        <a href="?page={{ current_chapter_page }}&chapter_id={{ current_chapter.id }}&per_page={{ chapters_per_page }}" 
                           class="btn ethereal-btn ethereal-btn-outline-primary btn-sm w-100" 
                           title="Navigate to current chapter">
                            <i class="fas fa-crosshairs me-2"></i>Find Current Chapter
                        </a>
                    </div>
                    {% endif %}
                    
                    <!-- Ethereal Pagination Size Selector -->
                    <div class="mt-2">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text ethereal-input-addon">
                                <i class="fas fa-layer-group me-1"></i>Per page:
                            </span>
                            <select class="form-select ethereal-select" onchange="changePaginationSize(this.value)">
                                <option value="5" {% if chapters_per_page == 5 %}selected{% endif %}>5</option>
                                <option value="10" {% if chapters_per_page == 10 %}selected{% endif %}>10</option>
                                <option value="15" {% if chapters_per_page == 15 %}selected{% endif %}>15</option>
                                <option value="25" {% if chapters_per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if chapters_per_page == 50 %}selected{% endif %}>50</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Ethereal Pagination Controls - Top -->
                {% if chapters.has_other_pages %}
                <div class="pagination-controls mb-3 mx-2">
                    <div class="alert ethereal-alert ethereal-alert-info py-2 px-3 mb-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <small><strong>Ethereal Note:</strong> Drag-and-drop reordering works within the current page only.</small>
                    </div>
                    <div class="btn-group btn-group-sm w-100 ethereal-btn-group" role="group">
                        {% if chapters.has_previous %}
                            <a href="?page=1{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="First page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ chapters.previous_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Previous page">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {% endif %}
                        
                        <span class="btn ethereal-btn ethereal-btn-secondary disabled">
                            {{ chapters.number }}/{{ chapters.paginator.num_pages }}
                        </span>
                        
                        {% if chapters.has_next %}
                            <a href="?page={{ chapters.next_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Next page">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ chapters.paginator.num_pages }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Last page">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div id="sortable-chapters">
                    {% for chapter in chapters %}
                        <div class="ethereal-chapter-item {% if current_chapter and chapter.id == current_chapter.id %}active{% endif %}" 
                             data-chapter-id="{{ chapter.id }}" 
                             onclick="loadChapter({{ chapter.id }})">
                            <div class="ethereal-drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="ethereal-chapter-number">{{ chapters.start_index|add:forloop.counter0 }}</div>
                            <div class="ethereal-chapter-title">{{ chapter.title|truncatechars:30 }}</div>
                            <div class="ethereal-chapter-actions">
                                <button class="ethereal-chapter-action-btn" onclick="event.stopPropagation(); deleteChapter({{ chapter.id }})" title="Delete chapter">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% empty %}
                        <div class="ethereal-chapter-item" style="justify-content: center; color: var(--ethereal-text-muted); font-style: italic; opacity: 0.7;">
                            <i class="fas fa-feather me-2"></i>
                            No chapters in this ethereal realm yet
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Ethereal Pagination Controls - Bottom -->
                {% if chapters.has_other_pages %}
                <div class="pagination-controls mt-3 mx-2">
                    <div class="btn-group btn-group-sm w-100 ethereal-btn-group" role="group">
                        {% if chapters.has_previous %}
                            <a href="?page=1{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="First page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ chapters.previous_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Previous page">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {% endif %}
                        
                        <span class="btn ethereal-btn ethereal-btn-secondary disabled">
                            {{ chapters.number }}/{{ chapters.paginator.num_pages }}
                        </span>
                        
                        {% if chapters.has_next %}
                            <a href="?page={{ chapters.next_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Next page">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ chapters.paginator.num_pages }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn ethereal-btn ethereal-btn-outline-secondary" title="Last page">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn ethereal-btn ethereal-btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="ethereal-add-chapter-section">
                <div class="ethereal-add-chapter-form">
                    <input type="text" 
                           id="new-chapter-title" 
                           class="ethereal-add-chapter-input" 
                           placeholder="New magical chapter title">
                    <button type="button" class="ethereal-add-chapter-btn" onclick="createChapter()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ethereal Document Editor -->
        <div class="ethereal-document-editor">
            {% if current_chapter %}
                <div class="ethereal-paper-container">
                    <div class="ethereal-paper-content">
                        <input type="text" 
                               id="chapter-title" 
                               class="ethereal-current-chapter-title" 
                               value="{{ current_chapter.title }}"
                               placeholder="Chapter title"
                               onchange="autoSave()">
                        
                        <div id="editor-content">
                            <textarea id="chapter-content" 
                                      class="ethereal-chapter-content-editor"
                                      placeholder="Let your ethereal story unfold..."
                                      oninput="autoSave()">{{ current_chapter.content|default:"" }}</textarea>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="ethereal-empty-editor">
                    <i class="fas fa-feather-alt ethereal-pulse"></i>
                    <h3>Begin Your Ethereal Journey</h3>
                    <p>Create your first chapter to start weaving your magical story.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Ethereal Right Sidebar with AI and Character Tools -->
        <div class="ethereal-right-sidebar" id="right-sidebar">
            <div class="ethereal-sidebar-header">
                <div class="ethereal-sidebar-tabs">
                    <button class="ethereal-sidebar-tab active" onclick="switchTab('ai')" id="ai-tab">
                        <i class="fas fa-robot"></i>
                        <span>AI Assist</span>
                    </button>
                    <button class="ethereal-sidebar-tab" onclick="switchTab('characters')" id="characters-tab">
                        <i class="fas fa-users"></i>
                        <span>Characters</span>
                    </button>
                </div>
                <button class="ethereal-sidebar-toggle" onclick="toggleRightSidebar()" title="Toggle ethereal sidebar">
                    <i class="fas fa-chevron-right" id="sidebar-toggle-icon"></i>
                </button>
            </div>
            
            <!-- Ethereal AI Assistant Panel -->
            <div class="ethereal-sidebar-panel active" id="ai-panel">
                <div class="ethereal-panel-content">
                    <div class="ethereal-ai-quick-actions">
                        <h6 class="ethereal-panel-title">Ethereal AI Assistance</h6>
                        <div class="ethereal-quick-action-grid">
                            <button class="ethereal-quick-action-btn" onclick="requestAIHelp('creativity')" title="Spark creative magic">
                                <i class="fas fa-lightbulb"></i>
                                <span>Inspire</span>
                            </button>
                            <button class="ethereal-quick-action-btn" onclick="requestAIHelp('grammar')" title="Perfect your prose">
                                <i class="fas fa-spell-check"></i>
                                <span>Refine</span>
                            </button>
                            <button class="ethereal-quick-action-btn" onclick="requestAIHelp('style')" title="Enhance your style">
                                <i class="fas fa-palette"></i>
                                <span>Enhance</span>
                            </button>
                            <button class="ethereal-quick-action-btn" onclick="requestAIHelp('continue')" title="Continue the magic">
                                <i class="fas fa-forward"></i>
                                <span>Continue</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="ethereal-ai-chat-section">
                        <h6 class="ethereal-panel-title">Ethereal Conversation</h6>
                        <div class="ethereal-ai-chat-container" id="ai-chat-container">
                            <div class="ethereal-welcome-message">
                                <i class="fas fa-robot ethereal-text-primary ethereal-pulse"></i>
                                <p>Greetings, ethereal writer! I'm your AI muse. Select text and click an action, or whisper your writing secrets to me.</p>
                            </div>
                        </div>
                        
                        <div class="ethereal-ai-input-section">
                            <div class="input-group">
                                <input type="text" 
                                       id="ai-input" 
                                       class="ethereal-ai-input" 
                                       placeholder="Share your ethereal writing thoughts..."
                                       onkeypress="handleAIInputKeypress(event)">
                                <button class="ethereal-ai-send-btn" onclick="sendAIMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ethereal Characters Panel -->
            <div class="ethereal-sidebar-panel" id="characters-panel">
                <div class="ethereal-panel-content">
                    <div class="ethereal-characters-header">
                        <h6 class="ethereal-panel-title">Ethereal Characters</h6>
                        <button class="ethereal-detect-characters-btn" onclick="detectCharacters()" title="Discover magical beings in your text">
                            <i class="fas fa-search me-1"></i>
                            Discover
                        </button>
                    </div>
                    
                    <div class="ethereal-characters-list" id="characters-list">
                        <div class="ethereal-no-characters-message">
                            <i class="fas fa-users ethereal-text-muted ethereal-pulse"></i>
                            <p>No ethereal beings detected yet. Click "Discover" to find the souls dwelling in your text.</p>
                        </div>
                    </div>
                    
                    <div class="ethereal-add-character-section">
                        <div class="input-group">
                            <input type="text" 
                                   id="new-character-name" 
                                   class="ethereal-character-input" 
                                   placeholder="Conjure a new character...">
                            <button class="ethereal-add-character-btn" onclick="addCharacter()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ethereal Auto-save Toast -->
<div class="ethereal-auto-save-toast" id="auto-save-toast">
    <i class="fas fa-save me-2"></i>Weaving magic into the ethereal realm...
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
<script>
let editor;
let autoSaveTimeout;
let pendingChanges = false;
let h2Elements = [];
let currentChapterId = {{ current_chapter.id|default:"null" }};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize drag-and-drop sorting
    const sortableList = document.getElementById('sortable-chapters');
    if (sortableList) {
        Sortable.create(sortableList, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function(evt) {
                evt.item.style.transform = 'rotate(5deg)';
            },
            onEnd: function(evt) {
                evt.item.style.transform = '';
                
                const chapterIds = Array.from(sortableList.children)
                    .filter(item => item.hasAttribute('data-chapter-id'))
                    .map(item => item.getAttribute('data-chapter-id'));
                
                // Send AJAX request to update order
                fetch('{% url "writer:chapter_editor" project.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'action': 'reorder',
                        'chapter_ids[]': chapterIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateChapterNumbers();
                        showToast('Chapter order updated');
                    }
                });
            }
        });
    }

    // Initialize CKEditor if there's content
    {% if current_chapter %}
    initializeEditor();
    {% endif %}
});

function initializeEditor() {
    const editorElement = document.getElementById('chapter-content');
    if (editorElement && !editor) {
        // Show loading indicator
        updateSaveStatus('loading', 'Loading editor...');
        
        ClassicEditor
            .create(editorElement, {
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'underline', '|',
                        'bulletedList', 'numberedList', '|',
                        'blockQuote', 'link', '|',
                        'undo', 'redo'
                    ]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                    ]
                },
                placeholder: 'Start writing your chapter...',
                // Performance optimizations
                balloonEditor: {
                    autoParagraph: false
                },
                link: {
                    decorators: {
                        addTargetToExternalLinks: true
                    }
                }
            })
            .then(editorInstance => {
                editor = editorInstance;
                
                // Hide loading indicator
                updateSaveStatus('saved', 'Editor ready');
                
                // Initialize H2 tracking
                initializeH2Tracking();
                
                // Debounced auto-save on content change
                let saveTimeout;
                editor.model.document.on('change:data', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        autoSave();
                    }, 1000); // Reduced frequency for better performance
                });
                
                // Listen for heading changes with debouncing
                let h2Timeout;
                editor.model.document.on('change', () => {
                    clearTimeout(h2Timeout);
                    h2Timeout = setTimeout(() => {
                        detectH2Creation();
                    }, 500);
                });
                
                // Restrict external paste - only allow internal operations
                editor.editing.view.document.on('paste', (evt, data) => {
                    const clipboardData = data.dataTransfer;
                    const isInternalPaste = sessionStorage.getItem('internal_copy_data');
                    
                    if (!isInternalPaste) {
                        evt.stop();
                        showPasteRestrictionMessage();
                        return;
                    }
                    
                    // Clear internal copy flag after use
                    sessionStorage.removeItem('internal_copy_data');
                });
                
                // Add custom copy/cut functionality
                editor.editing.view.document.on('copy', (evt, data) => {
                    sessionStorage.setItem('internal_copy_data', 'true');
                    sessionStorage.setItem('copy_timestamp', Date.now().toString());
                });
                
                editor.editing.view.document.on('cut', (evt, data) => {
                    sessionStorage.setItem('internal_copy_data', 'true');
                    sessionStorage.setItem('copy_timestamp', Date.now().toString());
                });
                
                // Auto-split long chapters
                editor.model.document.on('change:data', () => {
                    setTimeout(() => {
                        checkChapterLength();
                    }, 1000);
                });
                
                // Focus the editor
                editor.editing.view.focus();
                
                console.log('CKEditor initialized successfully');
            })
            .catch(error => {
                console.error('Error initializing CKEditor:', error);
                
                // Show fallback message
                updateSaveStatus('error', 'Editor failed to load - using basic text editor');
                
                // Fallback to textarea with enhanced styling
                editorElement.classList.add('fallback-active');
                editorElement.style.display = 'block';
                
                // Add basic auto-save for textarea
                editorElement.addEventListener('input', () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        autoSave();
                    }, 2000);
                });
                
                // Focus the textarea
                editorElement.focus();
            });
    }
}

function showPasteRestrictionMessage() {
    // Create and show a toast message
    const toast = document.createElement('div');
    toast.className = 'paste-restriction-toast';
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-upload text-primary"></i>
            <div class="toast-text">
                <strong>External paste disabled</strong><br>
                <small>Please upload documents instead. Only internal copy/paste is allowed.</small>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="toast-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

function checkChapterLength() {
    if (!editor || !currentChapterId) return;
    
    const content = editor.getData();
    const textContent = content.replace(/<[^>]*>/g, '').trim();
    
    // Count sentences (periods, question marks, exclamation marks)
    const sentences = textContent.split(/[.!?]+/).filter(s => s.trim().length > 0);
    
    if (sentences.length >= 4000) { // 4k sentences limit
        // Find the last complete sentence before the 4k mark
        const firstPart = sentences.slice(0, 3999).join('. ') + '.';
        const remainingPart = sentences.slice(3999).join('. ');
        
        if (remainingPart.trim()) {
            splitChapterAtLength(firstPart, remainingPart);
        }
    }
}

function splitChapterAtLength(firstPart, remainingPart) {
    if (!currentChapterId) return;
    
    // Update current chapter with first part
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'split_long_chapter',
            chapter_id: currentChapterId,
            first_part: firstPart,
            remaining_part: remainingPart
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update current editor with first part
            editor.setData(firstPart);
            
            // Show notification
            showAutoSplitNotification(data.new_chapter_title);
        }
    })
    .catch(error => {
        console.error('Error splitting chapter:', error);
    });
}

function showAutoSplitNotification(newChapterTitle) {
    const notification = document.createElement('div');
    notification.className = 'auto-split-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-scissors text-warning"></i>
            <div class="notification-text">
                <strong>Chapter automatically split</strong><br>
                <small>Content moved to: ${newChapterTitle}</small>
            </div>
            <button onclick="location.reload()" class="btn btn-sm btn-primary">
                Refresh
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 8000);
}

function initializeH2Tracking() {
    if (!editor) return;
    
    // Get initial H2 elements from the editor
    const currentData = editor.getData();
    const parser = new DOMParser();
    const doc = parser.parseFromString(currentData, 'text/html');
    h2Elements = Array.from(doc.querySelectorAll('h2'));
}

function detectH2Creation() {
    if (!editor) return;
    
    const currentData = editor.getData();
    const parser = new DOMParser();
    const doc = parser.parseFromString(currentData, 'text/html');
    const currentH2Elements = Array.from(doc.querySelectorAll('h2'));
    
    // Check if new H2 was added
    if (currentH2Elements.length > h2Elements.length) {
        const newH2 = currentH2Elements[currentH2Elements.length - 1];
        if (newH2 && newH2.textContent.trim()) {
            createChapterFromHeading(newH2.textContent.trim(), currentData);
        }
    }
    
    // Update stored H2 elements
    h2Elements = currentH2Elements;
}

function createChapterFromHeading(headingText, editorContent) {
    if (!headingText || !editorContent) return;
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'create_chapter_from_heading',
            current_chapter_id: currentChapterId,
            heading_text: headingText,
            editor_content: editorContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.redirect_url) {
            // Redirect to the new chapter
            window.location.href = data.redirect_url;
        } else {
            console.error('Failed to create chapter from heading:', data.error);
        }
    })
    .catch(error => {
        console.error('Error creating chapter from heading:', error);
    });
}

function loadChapter(chapterId) {
    // Save current chapter before switching
    if (currentChapterId && editor) {
        saveChapter(false);
    }
    
    // Show loading state
    updateSaveStatus('loading', 'Loading chapter...');
    
    // Get current page to preserve pagination
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = urlParams.get('page') || 1;
    const perPage = urlParams.get('per_page') || 10;
    
    // Navigate to the chapter, preserving the current page
    window.location.href = `{% url "writer:chapter_editor" project.id %}?chapter_id=${chapterId}&page=${currentPage}&per_page=${perPage}`;
}

function changePaginationSize(perPage) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentChapterId = urlParams.get('chapter_id') || '';
    
    // Navigate with new pagination size
    let newUrl = `{% url "writer:chapter_editor" project.id %}?per_page=${perPage}`;
    if (currentChapterId) {
        newUrl += `&chapter_id=${currentChapterId}`;
    }
    
    window.location.href = newUrl;
}

function autoSave() {
    if (!currentChapterId) return;
    
    // Clear existing timeout
    clearTimeout(autoSaveTimeout);
    
    // Update save status
    updateSaveStatus('saving', 'Saving...');
    
    // Set new timeout for auto-save
    autoSaveTimeout = setTimeout(() => {
        saveChapter();
    }, 1000);
}

function saveChapter(showToast = false) {
    if (!currentChapterId) return;
    
    const title = document.getElementById('chapter-title').value;
    const content = editor ? editor.getData() : document.getElementById('chapter-content').value;
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'save_chapter',
            'chapter_id': currentChapterId,
            'title': title,
            'content': content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateSaveStatus('saved', 'All changes saved');
            
            if (showToast) {
                showToast('Chapter saved successfully');
            }
            
            // Update chapter title in sidebar if it changed
            const sidebarItem = document.querySelector(`[data-chapter-id="${currentChapterId}"] .chapter-title`);
            if (sidebarItem && sidebarItem.textContent !== title) {
                sidebarItem.textContent = title.substring(0, 30) + (title.length > 30 ? '...' : '');
            }
        }
    })
    .catch(error => {
        console.error('Error saving chapter:', error);
        updateSaveStatus('error', 'Error saving');
    });
}

function createChapter() {
    const titleInput = document.getElementById('new-chapter-title');
    const title = titleInput.value.trim() || 'Untitled Chapter';
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'create_chapter',
            'title': title,
            'heading_level': 'h2'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            titleInput.value = '';
            window.location.href = data.redirect_url;
        }
    })
    .catch(error => {
        console.error('Error creating chapter:', error);
        showToast('Error creating chapter', 'error');
    });
}

function deleteChapter(chapterId) {
    if (!confirm('Are you sure you want to delete this chapter? This action cannot be undone.')) {
        return;
    }
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'delete_chapter',
            'chapter_id': chapterId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Chapter deleted');
            
            // If we're deleting the current chapter, redirect to project
            if (chapterId == currentChapterId) {
                window.location.href = `{% url "writer:chapter_editor" project.id %}`;
            } else {
                location.reload();
            }
        }
    })
    .catch(error => {
        console.error('Error deleting chapter:', error);
        showToast('Error deleting chapter', 'error');
    });
}

function updateChapterNumbers() {
    const chapters = document.querySelectorAll('.chapter-item[data-chapter-id]');
    chapters.forEach((chapter, index) => {
        const numberElement = chapter.querySelector('.chapter-number');
        if (numberElement) {
            numberElement.textContent = index + 1;
        }
    });
}

function updateSaveStatus(status, text) {
    const saveStatusElement = document.getElementById('save-status');
    if (!saveStatusElement) return;
    
    saveStatusElement.className = `ethereal-save-status ${status}`;
    
    const icon = saveStatusElement.querySelector('i');
    const textNode = saveStatusElement.childNodes[saveStatusElement.childNodes.length - 1];
    
    // Update icon with ethereal styling
    if (status === 'saving' || status === 'loading') {
        icon.className = 'fas fa-spinner fa-spin';
    } else if (status === 'saved') {
        icon.className = 'fas fa-check ethereal-icon-glow';
    } else if (status === 'error') {
        icon.className = 'fas fa-exclamation-triangle';
    }
    
    // Update text
    if (textNode.nodeType === Node.TEXT_NODE) {
        textNode.textContent = text;
    } else {
        saveStatusElement.appendChild(document.createTextNode(text));
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('auto-save-toast');
    if (!toast) return;
    
    const icon = type === 'error' ? 'fa-exclamation-triangle' : 'fa-magic';
    toast.innerHTML = `<i class="fas ${icon} me-2"></i>${message}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+S to save
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveChapter(true);
    }
    
    // Ctrl+Enter to create new chapter
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        const titleInput = document.getElementById('new-chapter-title');
        if (titleInput) {
            titleInput.focus();
        }
    }
});

// Handle Enter key in new chapter input
document.getElementById('new-chapter-title')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        createChapter();
    }
});

// Ethereal Right Sidebar Functionality
function toggleRightSidebar() {
    const sidebar = document.getElementById('right-sidebar');
    const icon = document.getElementById('sidebar-toggle-icon');
    
    sidebar.classList.toggle('collapsed');
    
    if (sidebar.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-left';
    } else {
        icon.className = 'fas fa-chevron-right';
    }
}

function switchTab(tabName) {
    // Update ethereal tab buttons
    document.querySelectorAll('.ethereal-sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Update ethereal panels
    document.querySelectorAll('.ethereal-sidebar-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById(tabName + '-panel').classList.add('active');
}

// AI Assistant Functionality
function requestAIHelp(type) {
    const selectedText = getSelectedText();
    const content = selectedText || (editor ? editor.getData() : document.getElementById('chapter-content').value);
    
    if (!content.trim()) {
        showAIMessage('assistant', 'Please write some content first, then I can help you improve it!');
        return;
    }
    
    // Show user's request
    const requestMessages = {
        'creativity': 'Help me with creative ideas for this text',
        'grammar': 'Please check the grammar and spelling',
        'style': 'Help me improve the writing style',
        'continue': 'Help me continue writing from here'
    };
    
    showAIMessage('user', requestMessages[type]);
    showAIMessage('assistant', 'Thinking...', true);
    
    // Make AI request
    fetch('{% url "writer:ai_assistant" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({
            'content': content,
            'assistance_type': getAIType(type),
            'prompt': requestMessages[type]
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove "Thinking..." message
        const messages = document.querySelectorAll('.ai-message.assistant');
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.textContent.includes('Thinking...')) {
            lastMessage.remove();
        }
        
        if (data.status === 'success') {
            showAIMessage('assistant', data.response);
        } else {
            showAIMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        }
    })
    .catch(error => {
        console.error('AI request error:', error);
        showAIMessage('assistant', 'Sorry, I encountered an error. Please try again.');
    });
}

function getAIType(type) {
    const typeMap = {
        'creativity': 'brainstorm',
        'grammar': 'grammar',
        'style': 'style',
        'continue': 'continue'
    };
    return typeMap[type] || 'brainstorm';
}

function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.value = '';
    showAIMessage('user', message);
    showAIMessage('assistant', 'Thinking...', true);
    
    const content = editor ? editor.getData() : document.getElementById('chapter-content').value;
    
    fetch('{% url "writer:ai_assistant" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({
            'content': content,
            'assistance_type': 'brainstorm',
            'prompt': message
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove "Thinking..." message
        const messages = document.querySelectorAll('.ai-message.assistant');
        const lastMessage = messages[messages.length - 1];
        if (lastMessage && lastMessage.textContent.includes('Thinking...')) {
            lastMessage.remove();
        }
        
        if (data.status === 'success') {
            showAIMessage('assistant', data.response);
        } else {
            showAIMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        }
    })
    .catch(error => {
        console.error('AI request error:', error);
        showAIMessage('assistant', 'Sorry, I encountered an error. Please try again.');
    });
}

function handleAIInputKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendAIMessage();
    }
}

function showAIMessage(sender, message, isTemporary = false) {
    const container = document.getElementById('ai-chat-container');
    
    // Remove ethereal welcome message if it exists
    const welcomeMessage = container.querySelector('.ethereal-welcome-message');
    if (welcomeMessage) {
        welcomeMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `ethereal-ai-message ${sender}`;
    messageDiv.innerHTML = `<div class="message-content">${message}</div>`;
    
    if (isTemporary) {
        messageDiv.setAttribute('data-temporary', 'true');
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function getSelectedText() {
    if (editor) {
        const selection = editor.model.document.selection;
        const selectedContent = editor.model.getSelectedContent(selection);
        return editor.data.stringify(selectedContent);
    } else {
        return window.getSelection().toString();
    }
}

// Character Detection Functionality
function detectCharacters() {
    const content = editor ? editor.getData() : document.getElementById('chapter-content').value;
    
    if (!content.trim()) {
        showToast('Please write some content first to detect characters.', 'info');
        return;
    }
    
    // Simple character name detection (capitalized words that appear multiple times)
    const text = content.replace(/<[^>]*>/g, ''); // Remove HTML tags
    const words = text.match(/\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)?\b/g) || [];
    
    // Count occurrences and filter potential character names
    const wordCounts = {};
    words.forEach(word => {
        // Skip common words that aren't likely to be character names
        const commonWords = ['The', 'A', 'An', 'This', 'That', 'Chapter', 'Book', 'Story', 'He', 'She', 'It', 'They', 'We', 'You', 'I'];
        if (!commonWords.includes(word) && word.length > 2) {
            wordCounts[word] = (wordCounts[word] || 0) + 1;
        }
    });
    
    // Filter names that appear more than once
    const characters = Object.entries(wordCounts)
        .filter(([name, count]) => count > 1)
        .sort((a, b) => b[1] - a[1]) // Sort by frequency
        .slice(0, 10); // Limit to top 10
    
    displayCharacters(characters);
    
    if (characters.length === 0) {
        showToast('No potential character names detected. Try writing more content with character names.', 'info');
    } else {
        showToast(`Detected ${characters.length} potential character(s).`, 'success');
    }
}

function displayCharacters(characters) {
    const container = document.getElementById('characters-list');
    
    if (characters.length === 0) {
        container.innerHTML = `
            <div class="ethereal-no-characters-message">
                <i class="fas fa-users ethereal-text-muted ethereal-pulse"></i>
                <p>No ethereal beings detected yet. Click "Discover" to find the souls dwelling in your text.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = characters.map(([name, count]) => `
        <div class="ethereal-character-item" data-character-name="${name}">
            <div class="ethereal-character-actions">
                <button class="ethereal-character-action-btn" onclick="removeCharacter('${name}')" title="Banish this character">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ethereal-character-name">${name}</div>
            <div class="ethereal-character-count">Appears ${count} times in the ethereal realm</div>
            <textarea class="ethereal-character-notes" 
                      placeholder="Write ethereal notes about ${name}..." 
                      onchange="saveCharacterNotes('${name}', this.value)"></textarea>
        </div>
    `).join('');
}

function addCharacter() {
    const input = document.getElementById('new-character-name');
    const name = input.value.trim();
    
    if (!name) return;
    
    // Check if character already exists
    const existing = document.querySelector(`[data-character-name="${name}"]`);
    if (existing) {
        showToast('Character already exists.', 'warning');
        input.value = '';
        return;
    }
    
    // Add to display
    const container = document.getElementById('characters-list');
    
    // Remove no-characters message if it exists
    const noCharactersMessage = container.querySelector('.no-characters-message');
    if (noCharactersMessage) {
        noCharactersMessage.remove();
    }
    
    const characterDiv = document.createElement('div');
    characterDiv.className = 'character-item';
    characterDiv.setAttribute('data-character-name', name);
    characterDiv.innerHTML = `
        <div class="character-actions">
            <button class="character-action-btn" onclick="removeCharacter('${name}')" title="Remove">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="character-name">${name}</div>
        <div class="character-count">Added manually</div>
        <textarea class="character-notes" 
                  placeholder="Add notes about ${name}..." 
                  onchange="saveCharacterNotes('${name}', this.value)"></textarea>
    `;
    
    container.appendChild(characterDiv);
    input.value = '';
    showToast(`Added character: ${name}`, 'success');
}

function removeCharacter(name) {
    const element = document.querySelector(`[data-character-name="${name}"]`);
    if (element) {
        element.remove();
        showToast(`Removed character: ${name}`, 'success');
        
        // Show no-characters message if no characters left
        const container = document.getElementById('characters-list');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="no-characters-message">
                    <i class="fas fa-users text-muted"></i>
                    <p>No characters detected yet. Click "Detect" to scan your text for character names.</p>
                </div>
            `;
        }
    }
}

function saveCharacterNotes(name, notes) {
    // Store in localStorage for persistence
    const storageKey = `character_notes_${currentChapterId}_${name}`;
    localStorage.setItem(storageKey, notes);
    showToast(`Notes saved for ${name}`, 'success');
}

// Load character notes from localStorage
function loadCharacterNotes() {
    if (!currentChapterId) return;
    
    document.querySelectorAll('.character-notes').forEach(textarea => {
        const characterItem = textarea.closest('.character-item');
        const name = characterItem.getAttribute('data-character-name');
        const storageKey = `character_notes_${currentChapterId}_${name}`;
        const notes = localStorage.getItem(storageKey);
        
        if (notes) {
            textarea.value = notes;
        }
    });
}

// Initialize character notes loading when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadCharacterNotes, 1000); // Delay to ensure content is loaded
});
</script>
{% endblock %}
