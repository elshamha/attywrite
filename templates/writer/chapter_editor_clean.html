{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.title }} - Writer's Web Dream{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css">
<style>
/* Clean Editor Styling */
.editor-container {
    height: calc(100vh - 60px);
    min-height: 650px;
    background: #f8f9fa;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}

.editor-toolbar {
    background: #ffffff;
    border-bottom: 1px solid #e9ecef;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.document-title {
    color: #333333;
    background: #ffffff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 16px;
    font-family: 'Lora', serif;
    min-width: 300px;
    font-size: 16px;
}

.document-title:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.editor-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.save-status {
    color: #28a745;
    font-size: 14px;
}

.upload-btn, .share-btn {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-btn:hover, .share-btn:hover {
    background: #0056b3;
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.chapter-sidebar {
    width: 300px;
    background: #ffffff;
    border-right: 1px solid #e9ecef;
    overflow-y: auto;
    flex-shrink: 0;
}

.outline-header {
    padding: 16px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

.outline-title {
    margin: 0;
    font-size: 16px;
    color: #333333;
}

.outline-content {
    padding: 16px;
}

.chapter-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.chapter-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.chapter-item:hover {
    background: #f8f9fa;
    border-color: #e9ecef;
}

.chapter-item.active {
    background: #007bff;
    color: white;
}

.chapter-number {
    background: #6c757d;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-right: 12px;
    flex-shrink: 0;
}

.chapter-item.active .chapter-number {
    background: white;
    color: #007bff;
}

.chapter-title {
    flex: 1;
    font-size: 14px;
}

.chapter-actions {
    display: flex;
    gap: 8px;
}

.chapter-action-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 4px;
    border-radius: 3px;
    transition: all 0.3s ease;
}

.chapter-action-btn:hover {
    background: #f8f9fa;
    color: #dc3545;
}

.chapter-item.active .chapter-action-btn {
    color: rgba(255, 255, 255, 0.7);
}

.chapter-item.active .chapter-action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.add-chapter-section {
    padding: 16px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.add-chapter-form {
    display: flex;
    gap: 8px;
}

.add-chapter-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.add-chapter-btn {
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
}

.add-chapter-btn:hover {
    background: #1e7e34;
}

.document-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.paper-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #ffffff;
}

.paper-content {
    max-width: 800px;
    margin: 0 auto;
    background: #ffffff;
    min-height: 100%;
}

.current-chapter-title {
    width: 100%;
    border: none;
    font-size: 24px;
    font-weight: bold;
    padding: 20px 0;
    margin-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
    color: #333333;
    background: transparent;
}

.current-chapter-title:focus {
    outline: none;
    border-bottom-color: #007bff;
}

.chapter-content-editor {
    width: 100%;
    min-height: 500px;
    border: none;
    font-family: 'Lora', serif;
    font-size: 16px;
    line-height: 1.6;
    color: #333333;
    background: #ffffff;
    resize: none;
    padding: 0;
}

.chapter-content-editor:focus {
    outline: none;
}

.empty-editor {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    text-align: center;
}

.empty-editor i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.pagination-controls {
    padding: 8px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.pagination-info {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 8px;
}

/* CKEditor specific overrides */
.ck-editor__editable {
    color: #333333 !important;
    background: #ffffff !important;
    border: none !important;
    box-shadow: none !important;
    min-height: 500px !important;
}

.ck-editor__main {
    background: #ffffff !important;
}

.ck-content {
    color: #333333 !important;
    font-family: 'Lora', serif !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1050;
}

.toast {
    min-width: 300px;
}

/* File upload styling */
.upload-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.upload-overlay.active {
    opacity: 1;
    visibility: visible;
}

.upload-content {
    background: white;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
    max-width: 500px;
    width: 90%;
}

/* Responsive design */
@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }
    
    .chapter-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid #e9ecef;
    }
    
    .document-title {
        min-width: 200px;
        font-size: 14px;
    }
    
    .editor-actions {
        gap: 5px;
    }
    
    .upload-btn, .share-btn {
        padding: 6px 12px;
        font-size: 14px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Editor Toolbar -->
    <div class="editor-toolbar">
        <input type="text" 
               class="document-title" 
               value="{{ project.title }}" 
               placeholder="Project Title"
               onchange="updateProjectTitle(this.value)">
        
        <div class="editor-actions">
            <span class="save-status" id="save-status">
                <i class="fas fa-check"></i>
                All changes saved
            </span>
            
            <!-- Direct Upload Button -->
            <button class="upload-btn" id="direct-upload-btn" title="Upload file directly to editor">
                <i class="fas fa-upload me-2"></i>
                Upload File
            </button>
            
            <!-- Hidden File Input -->
            <input type="file" 
                   id="direct-upload-input" 
                   style="display: none;" 
                   accept=".txt,.html,.htm,.docx,.doc,.pdf,.rtf,.odt">

            <button class="share-btn">
                <i class="fas fa-share me-2"></i>
                Share
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Chapter Outline Sidebar -->
        <div class="chapter-sidebar">
            <div class="outline-header">
                <h3 class="outline-title">
                    <i class="fas fa-list-ul me-2"></i>
                    Chapter Outline
                </h3>
            </div>
            
            <div class="outline-content">
                <!-- Pagination Info -->
                {% if chapters.has_other_pages %}
                <div class="pagination-info mb-3 p-2 bg-light rounded border">
                    <small class="text-muted d-block mb-2">
                        <i class="fas fa-scroll me-1"></i>
                        Chapters {{ chapters.start_index }}-{{ chapters.end_index }} of {{ chapters.paginator.count }}
                        (Page {{ chapters.number }} of {{ chapters.paginator.num_pages }})
                    </small>
                </div>
                {% endif %}
                
                <!-- Chapter List -->
                <div class="chapter-list" id="chapter-list">
                    {% for chapter in chapters %}
                        <div class="chapter-item {% if current_chapter and chapter.id == current_chapter.id %}active{% endif %}" 
                             onclick="loadChapter({{ chapter.id }})"
                             data-chapter-id="{{ chapter.id }}">
                            <div class="chapter-number">{{ chapters.start_index|add:forloop.counter0 }}</div>
                            <div class="chapter-title">{{ chapter.title|truncatechars:30 }}</div>
                            <div class="chapter-actions">
                                <button class="chapter-action-btn" onclick="event.stopPropagation(); deleteChapter({{ chapter.id }})" title="Delete chapter">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% empty %}
                        <div class="chapter-item" style="justify-content: center; color: #6c757d; font-style: italic;">
                            <i class="fas fa-feather me-2"></i>
                            No chapters yet
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination Controls -->
                {% if chapters.has_other_pages %}
                <div class="pagination-controls mt-3">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        {% if chapters.has_previous %}
                            <a href="?page=1{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn btn-outline-secondary" title="First page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ chapters.previous_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn btn-outline-secondary" title="Previous page">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {% endif %}
                        
                        <span class="btn btn-secondary disabled">
                            {{ chapters.number }}/{{ chapters.paginator.num_pages }}
                        </span>
                        
                        {% if chapters.has_next %}
                            <a href="?page={{ chapters.next_page_number }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn btn-outline-secondary" title="Next page">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ chapters.paginator.num_pages }}{% if current_chapter %}&chapter_id={{ current_chapter.id }}{% endif %}" 
                               class="btn btn-outline-secondary" title="Last page">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="add-chapter-section">
                <div class="add-chapter-form">
                    <input type="text" 
                           id="new-chapter-title" 
                           class="add-chapter-input" 
                           placeholder="New chapter title">
                    <button type="button" class="add-chapter-btn" onclick="createChapter()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Document Editor -->
        <div class="document-editor">
            {% if current_chapter %}
                <div class="paper-container">
                    <div class="paper-content">
                        <input type="text" 
                               id="chapter-title" 
                               class="current-chapter-title" 
                               value="{{ current_chapter.title }}"
                               placeholder="Chapter title"
                               onchange="autoSave()">
                        
                        <div id="editor-content">
                            <textarea id="chapter-content" 
                                      class="chapter-content-editor"
                                      placeholder="Start writing your chapter..."
                                      oninput="autoSave()">{{ current_chapter.content|default:"" }}</textarea>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="empty-editor">
                    <i class="fas fa-feather-alt"></i>
                    <h3>Welcome to Your Writing Space</h3>
                    <p>Select a chapter from the sidebar or create a new one to start writing.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('new-chapter-title').focus()">
                        <i class="fas fa-plus me-2"></i>Create Your First Chapter
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Upload Overlay -->
<div class="upload-overlay" id="upload-overlay">
    <div class="upload-content">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5>Processing File...</h5>
        <p>Please wait while we process your uploaded file.</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

<script>
let editor = null;
let autoSaveTimeout = null;
let currentChapterId = {% if current_chapter %}{{ current_chapter.id }}{% else %}null{% endif %};
let projectId = {{ project.id }};

document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    setupFileUpload();
    setupAutoSave();
});

function initializeEditor() {
    const editorElement = document.getElementById('chapter-content');
    if (!editorElement) return;

    ClassicEditor
        .create(editorElement, {
            toolbar: [
                'heading', '|',
                'bold', 'italic', 'underline', '|',
                'bulletedList', 'numberedList', '|',
                'outdent', 'indent', '|',
                'blockQuote', 'insertTable', '|',
                'undo', 'redo'
            ],
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                ]
            }
        })
        .then(newEditor => {
            editor = newEditor;
            editor.model.document.on('change:data', () => {
                scheduleAutoSave();
            });
        })
        .catch(error => {
            console.error('Error initializing editor:', error);
        });
}

function setupFileUpload() {
    const uploadBtn = document.getElementById('direct-upload-btn');
    const fileInput = document.getElementById('direct-upload-input');
    
    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', handleFileUpload);
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const overlay = document.getElementById('upload-overlay');
    overlay.classList.add('active');
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('action', 'upload_file');
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        overlay.classList.remove('active');
        if (data.status === 'success') {
            if (editor && data.content) {
                editor.setData(data.content);
            }
            showToast('File uploaded successfully!', 'success');
        } else {
            showToast(data.message || 'Upload failed', 'error');
        }
    })
    .catch(error => {
        overlay.classList.remove('active');
        console.error('Upload error:', error);
        showToast('Upload failed', 'error');
    });
    
    // Reset file input
    event.target.value = '';
}

function setupAutoSave() {
    const titleInput = document.getElementById('chapter-title');
    if (titleInput) {
        titleInput.addEventListener('input', scheduleAutoSave);
    }
}

function scheduleAutoSave() {
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }
    
    autoSaveTimeout = setTimeout(autoSave, 2000); // Auto-save after 2 seconds of inactivity
    
    // Update status
    const status = document.getElementById('save-status');
    if (status) {
        status.innerHTML = '<i class="fas fa-clock text-warning"></i> Saving...';
    }
}

function autoSave() {
    if (!currentChapterId) return;
    
    const titleInput = document.getElementById('chapter-title');
    const title = titleInput ? titleInput.value : '';
    
    let content = '';
    if (editor) {
        content = editor.getData();
    } else {
        const textArea = document.getElementById('chapter-content');
        content = textArea ? textArea.value : '';
    }
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'save_chapter',
            'chapter_id': currentChapterId,
            'title': title,
            'content': content
        })
    })
    .then(response => response.json())
    .then(data => {
        const status = document.getElementById('save-status');
        if (data.status === 'success') {
            if (status) {
                status.innerHTML = '<i class="fas fa-check text-success"></i> All changes saved';
            }
        } else {
            if (status) {
                status.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Save failed';
            }
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
        const status = document.getElementById('save-status');
        if (status) {
            status.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Save failed';
        }
    });
}

function loadChapter(chapterId) {
    window.location.href = `{% url "writer:chapter_editor" project.id %}?chapter_id=${chapterId}`;
}

function createChapter() {
    const titleInput = document.getElementById('new-chapter-title');
    const title = titleInput.value.trim();
    
    if (!title) {
        titleInput.focus();
        return;
    }
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'create_chapter',
            'title': title,
            'heading_level': 'h2'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            titleInput.value = '';
            window.location.href = data.redirect_url;
        }
    })
    .catch(error => {
        console.error('Error creating chapter:', error);
        showToast('Error creating chapter', 'error');
    });
}

function deleteChapter(chapterId) {
    if (!confirm('Are you sure you want to delete this chapter? This action cannot be undone.')) {
        return;
    }
    
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'delete_chapter',
            'chapter_id': chapterId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Chapter deleted');
            
            // If we're deleting the current chapter, redirect to project
            if (chapterId == currentChapterId) {
                window.location.href = `{% url "writer:chapter_editor" project.id %}`;
            } else {
                location.reload();
            }
        }
    })
    .catch(error => {
        console.error('Error deleting chapter:', error);
        showToast('Error deleting chapter', 'error');
    });
}

function updateProjectTitle(title) {
    fetch('{% url "writer:chapter_editor" project.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'action': 'update_project_title',
            'title': title
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Project title updated', 'success');
        }
    })
    .catch(error => {
        console.error('Error updating project title:', error);
    });
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'success' ? 'fa-check-circle text-success' : 
                     type === 'error' ? 'fa-exclamation-circle text-danger' : 
                     'fa-info-circle text-info';
    
    const toastHtml = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas ${iconClass} me-2"></i>
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+S to save
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        autoSave();
    }
    
    // Ctrl+N to create new chapter
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        document.getElementById('new-chapter-title').focus();
    }
});

// Auto-save on page unload
window.addEventListener('beforeunload', function() {
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
        autoSave();
    }
});
</script>
{% endblock %}
